{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Listings" %}{% endblock %}
{% block content %}
<h1>{% trans "Listings" %}</h1>

<form method="get" action="{% url 'auction:index' %}">
  <label for="sort_by">{% trans "Filter by:" %}</label>
  <select name="sort_by" id="sort_by">
    <option value="end_time" {% if sort_by == 'end_time' %}selected{% endif %}>{% trans "All" %}</option>
    <option value="highest_bid" {% if sort_by == 'highest_bid' %}selected{% endif %}>{% trans "Highest Bid" %}</option>
    <option value="lowest_bid" {% if sort_by == 'lowest_bid' %}selected{% endif %}>{% trans "Lowest Bid" %}</option>
    <option value="fastest_ending" {% if sort_by == 'fastest_ending' %}selected{% endif %}>{% trans "Fastest Ending" %}</option>
    <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>{% trans "Oldest" %}</option>
  </select>
  <button type="submit">{% trans "Apply" %}</button>
</form>

<ul id="auction-list">
  {% for auction, current_bid in auctions_with_bids %}
  <li id="auction-{{ auction.id }}">
    <a href="{% url 'auction:auction_detail' auction.id %}">{{ auction.fish.name }}</a>
    - {% trans "Current highest bid" %}: <span class="bid-amount">{{ current_bid }}</span> EUR 
    {% if auction.is_ended %} - <strong>{% trans "Ended" %}</strong>{% endif %}
  </li>
  {% endfor %}
</ul>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const auctionList = document.getElementById('auction-list');
    const userLang = navigator.language || navigator.userLanguage;
    const socket = new WebSocket('ws://' + window.location.host + '/ws/auctions/');

    socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const auctionElement = document.getElementById('auction-' + data.auction_id);
      if (auctionElement) {
        auctionElement.querySelector('.bid-amount').textContent = data.bid;
      }
    };

    socket.onclose = function(event) {
      console.error('WebSocket closed unexpectedly');
    };

    socket.onerror = function(error) {
      console.error('WebSocket error observed:', error);
    };
  });

  const auctionSocket = new WebSocket('ws://127.0.0.1:8001/ws/auction/');

  auctionSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log('Message received:', data.message);
      // Update the bid list or other elements with the new bid information
  };

  auctionSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };

  function sendMessage(message) {
      auctionSocket.send(JSON.stringify({
          'message': message
      }));
  }
</script>
{% endblock %}
